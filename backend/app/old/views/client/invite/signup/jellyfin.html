<div class="flex flex-col space-y-4">
    <h1 id="carousel-title" class="h-8 relative text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white">
        <span data-item="carousel-item-1" class="px-6 absolute inset-0 z-10 hidden">{{ _("Join the Jellyfin Server") }}</span>
        <span data-item="carousel-item-2" class="px-6 absolute inset-0 z-10 hidden">{{ _("Create your account") }}</span>
        <span data-item="carousel-item-3" class="px-6 absolute inset-0 z-10 hidden">{{ _("Setup your password") }}</span>
        <span data-item="carousel-item-4" class="px-6 absolute inset-0 z-10 hidden">{{ _("Please wait") }}</span>
        <span data-item="carousel-item-5" class="px-6 absolute inset-0 z-10 hidden">{{ _("Almost done") }}</span>
        <span data-item="carousel-item-6" class="px-6 absolute inset-0 z-10 hidden">{{ _("Account created") }}</span>
        <span data-item="carousel-item-7" class="px-6 absolute inset-0 z-10 hidden">{{ _("Please try again") }}</span>
    </h1>

    <div class="relative w-full">
        <!-- Carousel wrapper -->
        <div id="carousel" class="relative overflow-hidden rounded" style="height: 1000px; max-height:0px; transition: max-height 0.3s ease-in-out;">
            <!-- Blank Carousel Item to prevent wrap around -->
            <div id="carousel-item-0" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
                </div>
            </div>

            <!-- Carousel Item 1 -->
            <div id="carousel-item-1" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
                    <form onsubmit="event.preventDefault(); verifyInvite(this);">
                        <div class="space-y-2 md:space-y-3">
                            <div>
                                <label for="code" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ _("Invite Code") }}
                                </label>

                                <input type="code" name="code" id="code" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="XMFGEJI" value="{{ code }}" required="">
                            </div>

                            <button type="submit" class="w-full text-white bg-primary hover:bg-primary_hover focus:outline-none font-medium rounded text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover">
                                {{ _("Join") }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Carousel Item 2 -->
            <div id="carousel-item-2" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
                    <form onsubmit="event.preventDefault(); verifyAccount(this);">
                        <div class="space-y-2 md:space-y-3">
                            <div>
                                <label for="username" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ _("Username") }}
                                </label>
                                <input type="username" name="username" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="marvin" required="" autocomplete="username">
                            </div>
                            <div>
                                <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ _("Email") }}
                                </label>
                                <input type="email" name="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="marvin@wizarr.dev" required="" autocomplete="email">
                            </div>

                            <button type="submit" class="w-full text-white bg-primary hover:bg-primary_hover focus:outline-none font-medium rounded text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover">
                                {{ _("Create Account") }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Carousel Item 3 -->
            <div id="carousel-item-3" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
                    <form onsubmit="event.preventDefault(); setupJellyfin(this);">
                        <div class="space-y-2 md:space-y-3">
                            <div>
                                <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ _("Password") }}
                                </label>
                                <input type="password" name="password" id="password" placeholder="••••••••" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required="" autocomplete="new-password">
                            </div>
                            <div>
                                <label for="confirm-password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    {{ _("Confirm password") }}
                                </label>
                                <input type="password" name="confirm-password" id="confirm-password" placeholder="••••••••" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required="" autocomplete="new-password">
                            </div>

                            <button type="submit" class="w-full text-white bg-primary hover:bg-primary_hover focus:outline-none font-medium rounded text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover">
                                {{ _("Save Password") }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Carousel Item 4 -->
            <div id="carousel-item-4" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                </div>
            </div>

            <!-- Carousel Item 5 -->
            <div id="carousel-item-5" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800 flex items-center justify-center">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
                    <ol id="stepper" class="flex items-center w-full">
                        <li class="flex w-full items-center after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-100 after:dark:border-gray-700 after:border-4 after:inline-block" style="transition: border-color 0.3s ease;">
                            <span class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full lg:h-12 lg:w-12 dark:bg-gray-700 shrink-0" style="transition: background-color 0.3s ease;">
                                <i class="fas fa-user-plus"></i>
                            </span>
                        </li>
                        <li class="flex w-full items-center after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-100 after:dark:border-gray-700 after:border-4 after:inline-block" style="transition: border-color 0.3s ease;">
                            <span class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full lg:h-12 lg:w-12 dark:bg-gray-700 shrink-0" style="transition: background-color 0.3s ease;">
                                <i class="fas fa-user"></i>
                            </span>
                        </li>
                        <li class="flex items-center">
                            <span class="flex items-center justify-center w-10 h-10 bg-gray-100 rounded-full lg:h-12 lg:w-12 dark:bg-gray-700 shrink-0" style="transition: background-color 0.3s ease;">
                                <i class="fas fa-check"></i>
                            </span>
                        </li>
                    </ol>
                </div>
            </div>


            <!-- Carousel Item 6 -->
            <div id="carousel-item-6" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800 flex items-center justify-center">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 flex items-center flex-col space-y-4 md:space-y-6">
                    <p class="w-full text-sm font-medium text-gray-900 dark:text-white">
                        {{ _("You're all set, click continue to get started and walkthrough how to use Jellyfin!") }}
                    </p>
                    <button onclick="location = '/help'" class="w-full text-white bg-primary hover:bg-primary_hover focus:outline-none font-medium rounded text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover">
                        {{ _("Continue") }}
                    </button>
                </div>
            </div>

            <!-- Carousel Item 7 -->
            <div id="carousel-item-7" class="hidden duration-700 ease-in-out bg-white dark:bg-gray-800 flex items-center justify-center">
                <div class="px-6 absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 flex items-center flex-col space-y-4 md:space-y-6">
                    <p id="failed-flow" class="w-full text-sm font-medium text-gray-900 dark:text-white text-left">
                        {{ _("Something went wrong, please try again.") }}
                    </p>
                    <button onclick="location.reload()" class="w-full text-white bg-primary hover:bg-primary_hover focus:outline-none font-medium rounded text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover">
                        {{ _("Retry") }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script defer>
    document.addEventListener("DOMContentLoaded", function () {

        // Get the carousel and all the divs inside it with id's that start with carousel-item
        const carousel = document.getElementById('carousel');
        const carouselItems = carousel.querySelectorAll('div[id^="carousel-item"]');

        // Create an array of carousel items, with el: the element and position: the index of the element
        const carouselItemsArray = [];

        carouselItems.forEach((el, index) => {
            carouselItemsArray.push({
                el: el,
                position: index
            });
        });

        const options = {
            defaultPosition: 1,
            onChange: async (step) => {
                // Adjust the height of the carousel to the height of the current step
                let active = step._getActiveItem();
                let child = active.el.children[0];
                let childHeight = child.offsetHeight;

                // If the height is enlarging animate it fast, if it's shrinking animate it slower
                if (childHeight > carousel.offsetHeight) {
                    const transition = carousel.style.transition;
                    carousel.style.transition = 'max-height 0.1s ease-in-out';
                    carousel.style.maxHeight = childHeight + 'px';
                    await new Promise(resolve => setTimeout(resolve, 100));
                    carousel.style.transition = transition;
                } else {
                    setTimeout(() => {
                        carousel.style.maxHeight = childHeight + 'px';
                    }, 300);
                }


                // Unhide the title inside carousel-title where the data-item attribute matches the current steps id
                let titleBlock = document.getElementById('carousel-title');
                let title = titleBlock.querySelector('[data-item="' + active.el.id + '"]');

                titleBlock.querySelectorAll('span').forEach((el) => {
                    el.classList.add('hidden');
                    el.classList.remove('animate__animated', 'animate__fadeIn');
                });

                title?.classList.remove('hidden');
                title?.classList.add('animate__animated', 'animate__fadeIn');
            }
        };

        window.carousel = new Carousel(carouselItemsArray, options);

    });

    async function verifyInvite(form) {
        // Get the invite code from the form
        const inviteCode = form.querySelector('input[name="code"]').value;

        // TODO: Verify the invite code

        // Move to the next step
        carousel.next();
    }

    async function verifyAccount(form) {
        // Get the username and email from the form
        const username = form.querySelector('input[name="username"]').value;
        const email = form.querySelector('input[name="email"]').value;

        // TODO: Verify the username doesnt already exist

        // Move to the next step
        carousel.next();
    }

    async function wait(ms) {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }

    async function setupJellyfin(form) {
        // Get the first and second form
        const form1 = document.getElementById('carousel-item-1').querySelector('form');
        const form2 = document.getElementById('carousel-item-2').querySelector('form');

        // Get the code, username, email, and password from the forms
        const code = form1.querySelector('input[name="code"]').value;
        const username = form2.querySelector('input[name="username"]').value;
        const email = form2.querySelector('input[name="email"]').value;

        const password = form.querySelector('input[name="password"]').value;
        const confirmPassword = form.querySelector('input[name="confirm-password"]').value;

        // Check if the passwords match
        if (password !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }

        // Create a form data object to send to the server
        const formData = new FormData();
        const stepperController = new utils.stepper.StepperController(document.getElementById('stepper'));

        // Add the invite code, username, email, and password to the form data
        formData.append('code', code);
        formData.append('username', username);
        formData.append('email', email);
        formData.append('password', password);

        // DEBUG: Log the form data
        console.table(Object.fromEntries(formData));

        // Move to the next step
        carousel.next();

        // Create socket.io connection with /jellyfin namespace
        const socket = window.utils.io('/jellyfin');

        // Create socket listeners
        socket.on('message', (message) => {
            toast.infoToast(message);
        });

        socket.on('error', async (error) => {
            // Slide to last step and show error
            await wait(500);
            carousel.slideTo(carousel._items.length - 1);
            toast.errorToast(error);
        });

        socket.on('step', (step) => {
            // Set the active step to the step sent by the server
            stepperController.setActiveStep(parseInt(step));
        });

        socket.on('done', () => {
            // Go to the next step
            carousel.next();
        });

        // Get title based on the current step id
        const currentStep = carousel._getActiveItem();
        const currentTitle = document.getElementById('carousel-title').querySelector('[data-item="' + currentStep.el.id + '"]');

        // Set the title to "Connecting to Server"
        currentTitle.innerText = "{{ _('Connecting to Server') }}";

        // Wait for connection
        await new Promise(resolve => socket.on('connect', resolve));

        // Add the socket id to the form data
        formData.append('socket_id', socket.id);

        // Set the title to "Creating Jellyfin Account"
        currentTitle.innerText = "{{ _('Creating Jellyfin Account') }}";

        // Wait half a second for no reason other than to look cool ;)
        await wait(500);

        // Send the form data to the server
        const jellyfin = await api.axios.post('/api/jellyfin', formData);

        // Check if the response was not successful
        if (jellyfin.status !== 200) {
            carousel.slideTo(carousel._items.length - 1);
        }

        // Go to the next step
        carousel.next();
    }
</script>