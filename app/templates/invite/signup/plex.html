<div class="flex flex-col space-y-4">
    <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white">
        {{ _("Join the Plex Server") }}
    </h1>

    <form class="space-y-4 md:space-y-6" action="/join" method="post">
        <div>
            <label for="code" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                {{ _("Invite Code") }}
            </label>

            <input type="code" name="code" id="code" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="XMFGEJI" value="{{ code }}" required="">
            <input type="hidden" name="token" id="token" value="">
        </div>

        <button onClick="oauth(); return false;" class="w-full text-white bg-primary hover:bg-primary_hover focus:ring-4 focus:outline-none focus:ring-amber-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover dark:focus:ring-primary_hover">
            {{ _("Join") }}
        </button>
    </form>
</div>
<script src="https://unpkg.com/bowser@2.7.0/es5.js"></script> <!-- needed for plexHeaders -->
<script>

    // nanoid package, for generating client-identifier in plexHeaders
    let nanoid = (t = 21) => crypto.getRandomValues(new Uint8Array(t)).reduce(((t, e) => t += (e &= 63) < 36 ? e.toString(36) : e < 62 ? (e - 26).toString(36).toUpperCase() : e > 62 ? "-" : "_"), "");

    // adapted from overseerr
    async function oauth() {
        let popup = window.open("", "Plex", 'width=600, height=700, toolbar=no, menubar=no');
        const browser = window.bowser.getParser(window.navigator.userAgent);
        const plexHeaders = {
            Accept: 'application/json',
            'X-Plex-Product': 'Wizarr',
            'X-Plex-Version': 'Plex OAuth',
            'X-Plex-Client-Identifier': nanoid(),
            'X-Plex-Model': 'Plex OAuth',
            'X-Plex-Platform': browser.getBrowserName(),
            'X-Plex-Platform-Version': browser.getBrowserVersion(),
            'X-Plex-Device': browser.getOSName(),
            'X-Plex-Device-Name': `${browser.getBrowserName()} (Wizarr)`,
            'X-Plex-Device-Screen-Resolution': `${window.screen.width}x${window.screen.height}`,
        }

        const pin = await fetch("https://plex.tv/api/v2/pins?strong=true", {
            method: "POST",
            headers: plexHeaders
        }).then(r => r.json())

        const params = new URLSearchParams({
            clientID: plexHeaders['X-Plex-Client-Identifier'],
            'context[device][product]': plexHeaders['X-Plex-Product'],
            'context[device][version]': plexHeaders['X-Plex-Version'],
            'context[device][platform]': plexHeaders['X-Plex-Platform'],
            'context[device][platformVersion]':
                plexHeaders['X-Plex-Platform-Version'],
            'context[device][device]': plexHeaders['X-Plex-Device'],
            'context[device][deviceName]': plexHeaders['X-Plex-Device-Name'],
            'context[device][model]': plexHeaders['X-Plex-Model'],
            'context[device][screenResolution]':
                plexHeaders['X-Plex-Device-Screen-Resolution'],
            'context[device][layout]': 'desktop',
            code: pin.code
        });

        popup.location.href = `https://app.plex.tv/auth/#!?${params}`;

        const authToken = await new Promise((resolve, reject) => {
            const currentTime = Date.now()
            const interval = setInterval(async () => {
                if (popup.closed) return location.reload();
                const resp = await fetch(`https://plex.tv/api/v2/pins/${pin.id}`, {
                    headers: plexHeaders
                }).then(r => r.json())

                if (resp?.errors?.length) return location.reload();
                if (resp?.authToken) {
                    clearInterval(interval)
                    resolve(resp.authToken);
                    return;
                }
            }, 1000)
        });
        document.querySelector("#token").value = authToken;

        console.log("authToken", authToken);
        document.forms[0].submit();
    }
</script>